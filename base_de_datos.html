<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BBDDINS – Base de datos de inspecciones</title>

<style>
  :root{
    --page-bg:#ffffff;
    --border:#000000;
    --header-bg:#ffffff;
    --header-text:#000000;
    --section-bg:#e6e6e6;
    --section-text:#000000;
    --body-text:#000000;

    /* Win95-ish */
    --w95-bg:#c0c0c0;
    --w95-light:#ffffff;
    --w95-dark:#808080;
    --w95-shadow:#404040;
    --w95-blue:#000080;
    --w95-hilite:#dfdfdf;
  }

  @page{ size:A4; margin:0; }
  html,body{height:100%}
  body{
    margin:0;
    font-family: "MS Sans Serif", Tahoma, Arial, Helvetica, sans-serif;
    background: var(--w95-bg);
    color: var(--body-text);
  }

  /* Topbar */
  .topbar{
    position:sticky; top:0; z-index:50;
    background: var(--w95-bg);
    padding:6px 8px 8px;
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
  }
  .topbar::before{
    content:"BBDDINS – Base de datos (inspecciones)";
    display:block;
    background: var(--w95-blue);
    color:#fff;
    font-weight:800;
    font-size:12px;
    letter-spacing:.2px;
    padding:4px 6px;
    margin:-6px -8px 8px -8px;
    border-bottom:1px solid #000;
  }
  .topbar .row{
    max-width:1200px;
    margin:0 auto;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;

    background: var(--w95-bg);
    padding:8px;
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
  }
  .group{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

  .topbar button,
  .topbar select,
  .topbar input[type="text"],
  .panel button,
  .panel select,
  .panel input[type="text"],
  .panel input[type="date"]{
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    background: var(--w95-bg);
    padding:6px 10px;
    font-weight:800;
    cursor:pointer;
    font-size:12px;
    font-family: inherit;
  }
  .topbar button:active,
  .panel button:active{
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
  }
  .topbar input[type="text"], .panel input[type="text"], .panel input[type="date"]{
    cursor:text;
    font-weight:700;
  }
  .topbar button.primary, .panel button.primary{ background: var(--w95-hilite); }
  .topbar button.danger, .panel button.danger{ background:#ffd6d6; }
  .topbar button:disabled, .panel button:disabled{ opacity:.5; cursor:not-allowed; }

  /* Importar JSON: texto negro */
  .topbar button.importBtn{ color:#000 !important; }

  .workspace{
    max-width:1200px;
    margin:12px auto;
    display:grid;
    grid-template-columns: minmax(320px, 520px) 1fr;
    gap:12px;
    padding:0 10px 20px;
    box-sizing:border-box;
  }

  /* Left panel */
  .panel{
    background: var(--w95-bg);
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    padding:10px;
    min-width:0;
  }
  .panel h3{
    margin:0 0 8px 0;
    font-size:12px;
    font-weight:900;
    background: var(--w95-blue);
    color:#fff;
    padding:4px 6px;
    border:1px solid #000;
  }
  .box{
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    padding:10px;
    background: var(--w95-bg);
    margin-bottom:12px;
    min-width:0;
  }
  .box h4{
    margin:0 0 10px 0;
    font-size:12px;
    font-weight:900;
    color:#000;
  }
  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .full{ grid-column: 1 / -1; }
  label{
    font-size:11px;
    font-weight:900;
    display:block;
    margin-bottom:6px;
  }
  .meta{
    margin-top:8px;
    font-size:11px;
    color:#000;
    line-height:1.35;
    border:1px solid #000;
    padding:8px 10px;
    background:#ffffe1;
    box-shadow: inset 1px 1px 0 #fff;
  }

  /* Drag & drop */
  .drop{
    border:1px dashed #000;
    background:#fff;
    padding:10px;
    font-size:11px;
    font-weight:900;
  }
  .drop.drag{ outline:2px dotted #000; }

  /* Historial (compacto tipo tabla) */
  .histControls{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .histControls .full{ grid-column: 1 / -1; }
  .histList{
    margin-top:8px;
    border:1px solid #000;
    background:#fff;
    max-height:520px;
    overflow:auto;
  }
  .histTable{
    width:100%;
    border-collapse:collapse;
    font-size:10px;
    line-height:1.15;
  }
  .histTable thead th{
    position:sticky; top:0;
    background:#f0f0f0;
    border-bottom:1px solid #000;
    text-align:left;
    padding:3px 6px;
    font-weight:900;
    z-index:1;
    white-space:nowrap;
  }
  .histTable tbody tr{ border-bottom:1px solid #ddd; }
  .histTable td{
    padding:2px 6px;
    vertical-align:middle;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:0;
  }
  .histTable td.tags{ color:#333; opacity:.9; }

  /* Columna "Inspección": usa menos altura (máx 2 líneas) */
  .histTable td:nth-child(4){
    white-space:normal;
    max-width:520px;
    line-height:1.15;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  .histTable td.actions{ width:190px; white-space:nowrap; }
  .histRowBtns{
    display:flex;
    gap:4px;
    flex-wrap:nowrap;
    align-items:center;
  }
  .histRowBtns .miniBtn{
    padding:2px 6px;
    font-size:10px;
    font-weight:800;
  }
  .histTable tr.active{ background:#eef3ff; }

  /* Requisito: Fecha/Categoría/Formulario/Acciones SIEMPRE completos */
  .histTable td.fecha,
  .histTable td.cat,
  .histTable td.form,
  .histTable td.actions,
  .histTable th.fecha,
  .histTable th.cat,
  .histTable th.form,
  .histTable th.actions{
    overflow:visible !important;
    text-overflow:clip !important;
    max-width:none !important;
    white-space:nowrap !important;
    width:1% !important;
  }

  .histEmpty{
    padding:8px;
    font-weight:900;
    font-size:11px;
  }

  /* A4 page */
  .page{
    width: min(210mm, 100%);
    min-height:297mm;
    margin:0 auto 14px auto;
    background: var(--page-bg);
    padding:10mm;
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    box-shadow: inset 1px 1px 0 #fff, 0 6px 18px rgba(0,0,0,.12);
    box-sizing:border-box;
  }

  body.exporting{
    background:#fff !important;
  }
  body.exporting .page{
    width:210mm !important;
    min-height:297mm !important;
    margin:0 !important;
    padding:10mm !important;
    box-shadow:none !important;
    border:none !important;
  }
  body.exporting .uiOnly{
    display:none !important;
  }

  /* ===== Documento (estructura fija) EXACTA del inspector ===== */
  .doc-header{
    border:2px solid var(--border);
    background: var(--header-bg);
    color: var(--header-text);
    padding:10px;
    margin-bottom:12px;
    display:flex;
    gap:12px;
    align-items:center;
    break-inside:avoid;
    page-break-inside:avoid;
  }
  .logo{
    width:190px;
    height:140px;
    border:2px solid var(--border);
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex: 0 0 auto;
  }
  .logo img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }
  .header-text{
    flex:1 1 auto;
    min-width:0;
  }
  .header-title{
    font-size:18px;
    font-weight:900;
    margin:0 0 4px 0;
    line-height:1.15;
    word-break:break-word;
  }
  .header-subtitle{
    font-size:12px;
    font-weight:800;
    margin:0;
    opacity:.95;
    word-break:break-word;
  }
  .header-meta{
    flex: 0 0 auto;
    text-align:right;
    min-width:190px;
    font-size:11px;
    font-weight:900;
    line-height:1.2;
    word-break:break-word;
  }
  .header-meta .muted{
    opacity:.85;
    font-weight:800;
  }

  .field{
    border:2px solid var(--border);
    margin-bottom:12px;
    background:#fff;
    break-inside:avoid;
    page-break-inside:avoid;
  }
  .field-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:6px;
    background: var(--section-bg);
    color: var(--section-text);
    border-bottom:2px solid var(--border);
  }
  .title{
    font-weight:900;
    font-size:14px;
    word-break:break-word;
    flex:1 1 auto;
    min-width:0;
  }
  .field-body{ padding:8px; }

  .textline input[type="text"]{
    width:100%;
    border:2px solid var(--border);
    padding:8px;
    font-size:14px;
    font-weight:500;
    box-sizing:border-box;
    color: var(--body-text);
    background:#fff;
    cursor:text;
  }
  textarea{
    width:100%;
    min-height:70px;
    resize:none;
    border:2px solid var(--border);
    padding:8px;
    font-size:14px;
    line-height:1.25;
    overflow:hidden;
    box-sizing:border-box;
    font-family: Arial, Helvetica, sans-serif;
    color: var(--body-text);
    background:#fff;
    cursor:text;
  }
  .opts{
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    margin-bottom:8px;
    font-size:16px;
    color: var(--body-text);
  }
  .opts label{ white-space:nowrap; font-weight:800; }

  /* pantalla: responsive; export/print: fijo */
  .photos{
    display:grid;
    grid-template-columns:repeat(4, 160px);
    gap:10px;
    margin-top:10px;
  }
  .photos img{
    width:160px;
    height:200px;
    object-fit:contain;
    border:2px solid var(--border);
    background:#fff;
    display:block;
  }
  body:not(.exporting) .photos{
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  }
  body:not(.exporting) .photos img{
    width:100%;
    height:auto;
    aspect-ratio: 4 / 5;
  }

  .photoTools{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .miniBtn{
    border:1px solid var(--border);
    background:#fff;
    padding:4px 8px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
  }

  @media print{
    .topbar,.panel{display:none !important;}
    .workspace{display:block; padding:0;}
    .page{width:210mm; margin:0; border:none; box-shadow:none; padding:10mm;}
    body{background:#fff;}
    .uiOnly{display:none !important;}
  }

  @media (max-width:1100px){
    .workspace{grid-template-columns:1fr;}
  }

  /* Ajustes extra para móviles (sin afectar export/print) */
  @media (max-width:720px){
    .topbar .row{ justify-content:flex-start; }
    .doc-header{
      flex-direction:column;
      align-items:stretch;
    }
    .header-meta{
      min-width:0;
      text-align:left;
    }
    .logo{
      width:100%;
      height:120px;
      max-width:320px;
    }
    .page{
      padding:10px;
      min-height:auto;
    }
    body.exporting .page{
      padding:10mm !important;
      min-height:297mm !important;
    }
  }
</style>
</head>

<body>

<div class="topbar uiOnly">
  <div class="row">
    <div class="group">
      <button class="primary importBtn" type="button" onclick="importJsonFiles()">Importar JSON</button>
      <button type="button" class="danger" onclick="clearDB()">Vaciar BBDD</button>
    </div>

    <div class="group">
      <button type="button" onclick="goHome()">← Menú</button>
    </div>
  </div>
</div>

<div class="workspace">
  <div class="panel uiOnly">
    <h3>Base de datos</h3>

    <div class="box">
      <h4>Importación</h4>
      <div id="dropZone" class="drop">
        Arrastra aquí uno o varios JSON de inspección (HIST_/BBDDINS_…).<br>
        También puedes usar “Importar JSON”.
      </div>
      <div class="meta" id="dbMeta">
        No hay datos cargados.
      </div>
    </div>

    <div class="box">
      <h4>Filtros</h4>
      <div class="histControls">
        <div class="full">
          <label>Búsqueda rápida</label>
          <input id="histSearch" type="text" placeholder="Filtra por texto libre…" oninput="renderList()" />
        </div>

        <div>
          <label>Categoría</label>
          <select id="histCat" onchange="onCatChange()">
            <option value="">(todas)</option>
          </select>
        </div>

        <div>
          <label>Formulario</label>
          <select id="histForm" onchange="renderList()">
            <option value="">(todos)</option>
          </select>
        </div>

        <div>
          <label>Desde (importación)</label>
          <input id="histFrom" type="date" onchange="renderList()" />
        </div>

        <div>
          <label>Hasta (importación)</label>
          <input id="histTo" type="date" onchange="renderList()" />
        </div>

        <div class="full">
          <label>TAG contiene</label>
          <input id="histTag" type="text" placeholder="Ej: EUC" oninput="renderList()" />
        </div>
      </div>

      <div class="histList" id="histList" aria-label="Listado de inspecciones"></div>

      <div class="photoTools uiOnly" style="margin-top:8px">
        <button class="miniBtn" type="button" onclick="downloadDBBackup()">Descargar copia (JSON)</button>
      </div>
    </div>
  </div>

  <div style="min-width:0;">
    <div id="capture" class="page">
      <div id="docHeader" class="doc-header">
        <div class="logo" id="logoBox"></div>
        <div class="header-text">
          <div id="docTitle" class="header-title"></div>
          <div id="docSubtitle" class="header-subtitle"></div>
        </div>
        <div class="header-meta">
          <div class="muted">Última edición</div>
          <div id="lastEdited">—</div>
        </div>
      </div>
      <div id="fieldsMount"></div>
    </div>
  </div>
</div>

<!-- libs (IGUAL que Inspector) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  /* =========================
     CONFIG (IGUAL que Inspector)
  ========================= */
  const FIXED_LOGO_URL = 'https://i.ibb.co/BK6jvxPG/image.png';

  /* =========================
     STORAGE
  ========================= */
  const DB_KEY = 'BBDDINS_DB_INSPECTIONS_V1';
  const ACTIVE_KEY = 'BBDDINS_DB_ACTIVE_ID_V1';

  /* =========================
     HELPERS (IGUAL estilo Inspector)
  ========================= */
  function escapeHTML(str){
    return String(str ?? '').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeAttr(str){
    return escapeHTML(str).replace(/"/g,'&quot;');
  }
  function safeJSONParse(txt){
    try{ return JSON.parse(txt); }catch(e){ return null; }
  }
  function normalize(s){ return String(s ?? '').trim(); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtLastEdited(iso){
    if(!iso) return '—';
    try{ return new Date(iso).toLocaleString('es-ES'); }catch(e){ return String(iso); }
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function exportStamp(d=new Date()){
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const da = pad2(d.getDate());
    const h = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    const s = pad2(d.getSeconds());
    return `${y}${m}${da}_${h}${mi}${s}`;
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function deepClone(obj){
    try{ return structuredClone(obj); }catch(e){ return JSON.parse(JSON.stringify(obj)); }
  }
  function makeId(){
    if(window.crypto && typeof window.crypto.randomUUID === 'function') return window.crypto.randomUUID();
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }

  /* =========================
     THEME + LOGO (IGUAL que Inspector)
  ========================= */
  function setVar(name, value){
    if(!value) return;
    document.documentElement.style.setProperty(name, value);
  }
  function getTheme(){
    const styles = getComputedStyle(document.documentElement);
    return {
      border: styles.getPropertyValue('--border').trim() || '#000000',
      headerBg: styles.getPropertyValue('--header-bg').trim() || '#ffffff',
      headerText: styles.getPropertyValue('--header-text').trim() || '#000000',
      sectionBg: styles.getPropertyValue('--section-bg').trim() || '#e6e6e6',
      sectionText: styles.getPropertyValue('--section-text').trim() || '#000000',
      pageBg: styles.getPropertyValue('--page-bg').trim() || '#ffffff'
    };
  }
  function applyFixedLogo(){
    const logoBox = document.getElementById('logoBox');
    if(!logoBox) return;
    logoBox.innerHTML = '';
    const img = document.createElement('img');
    img.src = FIXED_LOGO_URL;
    img.alt = 'Logo';
    logoBox.appendChild(img);
    logoBox.dataset.logo = FIXED_LOGO_URL;
  }

  function autoGrow(t){
    t.style.height = 'auto';
    t.style.height = (t.scrollHeight + 2) + 'px';
  }
  function refreshAutoGrow(){
    document.querySelectorAll('textarea.autogrow').forEach(autoGrow);
  }
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.matches('textarea.autogrow')) autoGrow(e.target);
  });

  /* =========================
     DB
  ========================= */
  function loadDB(){
    try{
      const raw = localStorage.getItem(DB_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    }catch(e){
      return [];
    }
  }
  function saveDB(items){
    try{ localStorage.setItem(DB_KEY, JSON.stringify(items || [])); }catch(e){}
  }
  function setActiveId(id){
    try{
      if(id) localStorage.setItem(ACTIVE_KEY, String(id));
      else localStorage.removeItem(ACTIVE_KEY);
    }catch(e){}
  }
  function getActiveId(){
    try{ return localStorage.getItem(ACTIVE_KEY) || ''; }catch(e){ return ''; }
  }

  function updateDbMeta(){
    const el = document.getElementById('dbMeta');
    const db = loadDB();
    const cats = [...new Set(db.map(x=>normalize(x.category)).filter(Boolean))].length;
    const forms = [...new Set(db.map(x=>normalize(x.form)).filter(Boolean))].length;
    const tags = [...new Set(db.flatMap(x=>Array.isArray(x.tags)?x.tags:[]).map(t=>normalize(t)).filter(Boolean))].length;
    el.innerHTML = `<b>Inspecciones:</b> ${db.length}<br><b>Categorías:</b> ${cats}<br><b>Formularios:</b> ${forms}<br><b>TAGs:</b> ${tags}`;
  }

  function clearDB(){
    const ok = confirm('¿Vaciar por completo la base de datos local?');
    if(!ok) return;
    saveDB([]);
    setActiveId('');
    updateDbMeta();
    refreshSelectors();
    renderList();
    renderEmptyDocument();
  }

  function downloadDBBackup(){
    const db = loadDB();
    const out = {
      version: 1,
      exportedAtISO: nowISO(),
      count: db.length,
      items: db
    };
    const stamp = exportStamp(new Date());
    const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
    downloadBlob(blob, `BBDDINS_DB_BACKUP_${stamp}.json`);
  }

  /* =========================
     NORMALIZE IMPORTS
     - Acepta: snapshot de Inspector (serializeCurrent) / HIST_... / BBDDINS_...
     - Acepta: backup de esta página {items:[...]}
  ========================= */
  function isBackup(obj){
    return !!(obj && typeof obj === 'object' && Array.isArray(obj.items) && (obj.version === 1 || obj.version === '1'));
  }

  function normalizeTags(tagsRaw){
    if(Array.isArray(tagsRaw)){
      return tagsRaw.map(x=>normalize(x)).filter(Boolean);
    }
    if(typeof tagsRaw === 'string'){
      return tagsRaw.split(',').map(x=>normalize(x)).filter(Boolean);
    }
    return [];
  }

  function normalizeInspection(raw, sourceFileName){
    if(!raw || typeof raw !== 'object') return null;

    const header = (raw.header && typeof raw.header === 'object') ? raw.header : {};
    const theme = (raw.theme && typeof raw.theme === 'object') ? raw.theme : {};
    const fields = Array.isArray(raw.fields) ? raw.fields : [];
    const meta = (raw.meta && typeof raw.meta === 'object') ? raw.meta : {};

    const category = normalize(meta.category || raw.category || '');
    const form = normalize(meta.name || meta.form || raw.name || raw.form || '');
    const tags = normalizeTags(meta.tags ?? raw.tags ?? []);

    const lastEditedISO = normalize(meta.inspectionLastEditedAtISO || meta.inspectionOpenedAtISO || meta.inspectionStartedAtISO || header.lastEdited || raw.lastEditedISO || '');
    const exportedAtISO = nowISO();

    // Id estable si viene del Inspector
    const inspectionId = normalize(meta.inspectionId || (raw.inspection && raw.inspection.id) || raw.inspectionId || raw.id || '');
    const id = inspectionId || makeId();

    // Fuerza logo fijo para que el documento sea EXACTO del inspector
    header.logo = FIXED_LOGO_URL;

    // Asegura theme completo (si falta, toma el actual por defecto)
    const curTheme = getTheme();
    const finalTheme = Object.assign({}, curTheme, theme);

    const dataSnapshot = {
      header: {
        title: header.title || '—',
        subtitle: header.subtitle || '',
        logo: FIXED_LOGO_URL,
        lastEdited: lastEditedISO || nowISO()
      },
      theme: finalTheme,
      fields: fields,
      meta: Object.assign({}, meta, {
        category: category || meta.category || '',
        name: form || meta.name || meta.form || '',
        tags: tags
      }),
      inspection: (raw.inspection && typeof raw.inspection === 'object') ? raw.inspection : undefined,
      historyExport: (raw.historyExport && Array.isArray(raw.historyExport)) ? raw.historyExport : undefined
    };

    return {
      id,
      inspectionId: inspectionId || id,
      category,
      form,
      tags,
      sourceFileName: String(sourceFileName || ''),
      importedAtISO: exportedAtISO,
      lastEditedISO: lastEditedISO || dataSnapshot.header.lastEdited,
      dataSnapshot
    };
  }

  function upsertMany(items){
    const db = loadDB();
    const map = new Map(db.map(x => [String(x.id), x]));
    let added = 0, updated = 0;

    for(const it of items){
      if(!it || !it.id) continue;
      const key = String(it.id);
      if(map.has(key)){
        const prev = map.get(key);
        map.set(key, Object.assign({}, prev, it, {
          importedAtISO: prev.importedAtISO || it.importedAtISO
        }));
        updated++;
      }else{
        map.set(key, it);
        added++;
      }
    }
    const out = Array.from(map.values());
    // orden por importación desc por defecto
    out.sort((a,b)=>String(b.importedAtISO||'').localeCompare(String(a.importedAtISO||'')));
    saveDB(out);

    updateDbMeta();
    refreshSelectors();
    renderList();

    // Auto cargar el más reciente importado
    const last = out[0];
    if(last) loadAndShow(last.id);

    return {added, updated};
  }

  function deleteOne(id){
    const ok = confirm('¿Eliminar este registro de la base local? (no borra archivos del disco)');
    if(!ok) return;
    const db = loadDB().filter(x=>String(x.id)!==String(id));
    saveDB(db);
    if(getActiveId() === String(id)) setActiveId('');
    updateDbMeta();
    refreshSelectors();
    renderList();
    renderEmptyDocument();
  }

  /* =========================
     SELECTORS (Cat/Form) para filtros
  ========================= */
  function uniqueCats(){
    return [...new Set(loadDB().map(e=>normalize(e.category)).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
  }
  function formsForCat(cat){
    const c = normalize(cat);
    return [...new Set(loadDB().filter(e=>normalize(e.category)===c).map(e=>normalize(e.form)).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
  }
  function refreshSelectors(keep=true){
    const catSel = document.getElementById('histCat');
    const formSel = document.getElementById('histForm');
    if(!catSel || !formSel) return;

    const prevCat = keep ? (catSel.value || '') : '';
    const prevForm = keep ? (formSel.value || '') : '';

    const cats = uniqueCats();
    catSel.innerHTML = '<option value="">(todas)</option>';
    cats.forEach(c=>{
      const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o);
    });
    if(prevCat && cats.includes(prevCat)) catSel.value = prevCat;

    const cat = catSel.value || '';
    const forms = cat ? formsForCat(cat) : [];
    formSel.innerHTML = '<option value="">(todos)</option>';
    forms.forEach(f=>{
      const o=document.createElement('option'); o.value=f; o.textContent=f; formSel.appendChild(o);
    });
    if(prevForm && forms.includes(prevForm)) formSel.value = prevForm;
  }
  function onCatChange(){
    refreshSelectors(true);
    renderList();
  }

  /* =========================
     RENDER DOCUMENT (IGUAL a Inspector)
  ========================= */
  let lastEditedISO = null;

  function updateLastEditedUI(){
    document.getElementById('lastEdited').textContent = fmtLastEdited(lastEditedISO);
  }

  function renderEmptyDocument(){
    lastEditedISO = nowISO();
    updateLastEditedUI();
    applyFixedLogo();

    document.getElementById('docTitle').textContent = '—';
    document.getElementById('docSubtitle').textContent = 'Importa JSON y carga una inspección';

    const mount = document.getElementById('fieldsMount');
    mount.innerHTML = '';
  }

  function fieldHTML(d, idx){
    const type = normalize(d.type) || 'text';
    const title = (d.title ?? '').toString();
    const config = (d.config && typeof d.config==='object') ? d.config : {};

    if(type === 'text'){
      const v = (d.value ?? '').toString();
      return `
        <div class="field" data-type="text" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body textline">
            <input type="text" value="${escapeAttr(v)}" readonly>
          </div>
        </div>
      `;
    }

    if(type === 'radio'){
      const options = Array.isArray(config.options) && config.options.length ? config.options : ["Bien","Mal","No dispone"];
      const selected = (d.selected ?? '').toString();
      const obs = (d.obs ?? '').toString();
      const name = `r_${idx}`;
      return `
        <div class="field" data-type="radio" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body">
            <div class="opts">
              ${options.map(o=>{
                const ck = (selected === o) ? 'checked' : '';
                return `<label><input type="radio" name="${name}" value="${escapeAttr(o)}" ${ck} disabled> ${escapeHTML(o)}</label>`;
              }).join('')}
            </div>
            <textarea class="autogrow" placeholder="Observaciones" readonly>${escapeHTML(obs)}</textarea>
          </div>
        </div>
      `;
    }

    if(type === 'photos'){
      const images = Array.isArray(d.images) ? d.images : [];
      return `
        <div class="field" data-type="photos" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body">
            <div class="photos" id="grid_${idx}">
              ${images.map((src)=>`
                <div>
                  <img src="${escapeAttr(src)}" alt="img">
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // fallback
    const v = (d.value ?? '').toString();
    return `
      <div class="field" data-type="${escapeAttr(type)}" data-idx="${idx}">
        <div class="field-head"><div class="title">${escapeHTML(title)}</div></div>
        <div class="field-body">
          <textarea class="autogrow" readonly>${escapeHTML(v || '')}</textarea>
        </div>
      </div>
    `;
  }

  function loadLayoutFromData(data){
    if(!data || typeof data !== 'object'){
      alert('Datos inválidos.');
      return;
    }

    // theme
    if(data.theme){
      setVar('--border', data.theme.border || '#000000');
      setVar('--header-bg', data.theme.headerBg || '#ffffff');
      setVar('--header-text', data.theme.headerText || '#000000');
      setVar('--section-bg', data.theme.sectionBg || '#e6e6e6');
      setVar('--section-text', data.theme.sectionText || '#000000');
      setVar('--page-bg', data.theme.pageBg || '#ffffff');
    }

    // header
    const h = data.header && typeof data.header==='object' ? data.header : {};
    const title = h.title || '';
    const subtitle = h.subtitle || '';

    lastEditedISO = h.lastEdited || nowISO();
    updateLastEditedUI();
    applyFixedLogo();

    document.getElementById('docTitle').textContent = title;
    document.getElementById('docSubtitle').textContent = subtitle;

    // fields
    const mount = document.getElementById('fieldsMount');
    const fields = Array.isArray(data.fields) ? data.fields : [];
    mount.innerHTML = fields.map((d,i)=>fieldHTML(d,i)).join('');

    refreshAutoGrow();
  }

  function loadAndShow(id){
    const db = loadDB();
    const it = db.find(x=>String(x.id)===String(id));
    if(!it || !it.dataSnapshot){
      alert('No se encontró la inspección.');
      return;
    }
    setActiveId(it.id);
    renderList();
    loadLayoutFromData(it.dataSnapshot);
  }

  /* =========================
     LIST (IGUAL estilo Inspector history)
  ========================= */
  function matchesQuery(entry, q){
    if(!q) return true;
    const hay = [
      entry.category,
      entry.form,
      Array.isArray(entry.tags) ? entry.tags.join(', ') : '',
      entry.importedAtISO,
      entry.lastEditedISO,
      entry.sourceFileName,
      entry.inspectionId,
      entry.id
    ].join(' | ').toLowerCase();
    return hay.includes(q);
  }

  function matchesFilters(entry){
    const q = normalize(document.getElementById('histSearch')?.value).toLowerCase();
    if(!matchesQuery(entry, q)) return false;

    const cat = normalize(document.getElementById('histCat')?.value);
    if(cat && normalize(entry.category)!==cat) return false;

    const form = normalize(document.getElementById('histForm')?.value);
    if(form && normalize(entry.form)!==form) return false;

    const tagQ = normalize(document.getElementById('histTag')?.value).toLowerCase();
    if(tagQ){
      const tags = Array.isArray(entry.tags) ? entry.tags.join(' ').toLowerCase() : '';
      if(!tags.includes(tagQ)) return false;
    }

    const from = document.getElementById('histFrom')?.value || '';
    const to = document.getElementById('histTo')?.value || '';
    if(from){
      const f = new Date(from+'T00:00:00Z').toISOString();
      if(String(entry.importedAtISO||'') < f) return false;
    }
    if(to){
      const t = new Date(to+'T23:59:59Z').toISOString();
      if(String(entry.importedAtISO||'') > t) return false;
    }

    return true;
  }

  function renderList(){
    const wrap = document.getElementById('histList');
    if(!wrap) return;

    const db = loadDB();
    const activeId = getActiveId();

    const items = db
      .slice()
      .sort((a,b)=>String(b.importedAtISO||'').localeCompare(String(a.importedAtISO||'')))
      .filter(matchesFilters);

    wrap.innerHTML = '';

    if(items.length === 0){
      const div = document.createElement('div');
      div.className = 'histEmpty';
      div.textContent = db.length === 0
        ? 'Importa uno o varios JSON para comenzar.'
        : 'No hay inspecciones que coincidan con los filtros.';
      wrap.appendChild(div);
      return;
    }

    const table = document.createElement('table');
    table.className = 'histTable';
    table.innerHTML = `
      <thead>
        <tr>
          <th class="fecha">Fecha</th>
          <th class="cat">Categoría</th>
          <th class="form">Formulario</th>
          <th>Inspección</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    items.forEach(e=>{
      const tr = document.createElement('tr');
      if(String(e.id)===String(activeId)) tr.classList.add('active');

      const tags = (Array.isArray(e.tags) && e.tags.length) ? e.tags.join(', ') : '—';
      const when = e.lastEditedISO ? fmtLastEdited(e.lastEditedISO) : '—';
      const title = (e.dataSnapshot && e.dataSnapshot.header && e.dataSnapshot.header.title) ? e.dataSnapshot.header.title : '—';
      const subtitle = (e.dataSnapshot && e.dataSnapshot.header && e.dataSnapshot.header.subtitle) ? e.dataSnapshot.header.subtitle : '';
      const insp = `${title}${subtitle ? ' — ' + subtitle : ''}`;

      tr.innerHTML = `
        <td class="fecha" title="${escapeAttr(when)}">${escapeHTML(when)}</td>
        <td class="cat" title="${escapeAttr(e.category||'')}">${escapeHTML(e.category||'—')}</td>
        <td class="form" title="${escapeAttr(e.form||'')}">${escapeHTML(e.form||'—')}</td>
        <td title="${escapeAttr(insp)}">${escapeHTML(insp)} <span class="tags" style="margin-left:6px; opacity:.9">${escapeHTML(tags)}</span></td>
        <td class="actions">
          <div class="histRowBtns uiOnly">
            <button class="miniBtn" type="button">Cargar</button>
            <button class="miniBtn" type="button">PDF</button>
            <button class="miniBtn danger" type="button">Eliminar</button>
          </div>
        </td>
      `;

      const btns = tr.querySelectorAll('button');
      const btnLoad = btns[0];
      const btnPdf = btns[1];
      const btnDel = btns[2];

      btnLoad.onclick = ()=>{
        loadAndShow(e.id);
      };
      btnPdf.onclick = async ()=>{
        loadAndShow(e.id);
        await exportPDFOnly(e.id);
      };
      btnDel.onclick = ()=> deleteOne(e.id);

      tbody.appendChild(tr);
    });

    wrap.appendChild(table);
  }

  /* =========================
     EXPORT PDF (MISMA rutina del Inspector)
     -> SOLO PDF (sin JSON), pero el PDF sale EXACTAMENTE igual.
  ========================= */
  async function exportPDFOnly(id){
    const db = loadDB();
    const entry = db.find(x=>String(x.id)===String(id));
    if(!entry || !entry.dataSnapshot){
      alert('No se pudo exportar (sin snapshot).');
      return;
    }

    // asegurar que el documento mostrado coincide con el snapshot
    try{
      loadLayoutFromData(entry.dataSnapshot);
    }catch(e){}

    refreshAutoGrow();
    applyFixedLogo();

    // nombre pdf como inspector (informe_Cat__Form__stamp.pdf)
    const category = normalize(entry.category) || 'Categoria';
    const form = normalize(entry.form) || 'Formulario';
    const stamp = exportStamp(new Date());

    const safeCat = category.replace(/[^\w\-ÁÉÍÓÚÜÑáéíóúüñ ]+/g,'').trim().replace(/\s+/g,'_') || 'Categoria';
    const safeName = form.replace(/[^\w\-ÁÉÍÓÚÜÑáéíóúüñ ]+/g,'').trim().replace(/\s+/g,'_') || 'Formulario';
    const pdfName = `informe_${safeCat}__${safeName}__${stamp}.pdf`;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

    const pageW = 210;
    const pageH = 297;
    const margin = 10;
    const contentW = pageW - margin*2;
    const contentH = pageH - margin*2;

    document.body.classList.add('exporting');

    async function renderEl(element){
      return await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY,
        onclone: (doc)=>{
          const cap = doc.getElementById('capture');
          if(cap){ cap.style.boxShadow = 'none'; cap.style.margin = '0'; }
          doc.querySelectorAll('.uiOnly').forEach(a => a.style.display = 'none');
        }
      });
    }

    try{
      const header = document.getElementById('docHeader');
      const fields = [...document.querySelectorAll('#capture .field')];
      const blocks = [header, ...fields];

      let cursorY = margin;

      for(const block of blocks){
        const canvas = await renderEl(block);
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        let blockWmm = contentW;
        let blockHmm = (canvas.height * blockWmm) / canvas.width;

        if(blockHmm > contentH){
          const scaleFactor = contentH / blockHmm;
          blockWmm = blockWmm * scaleFactor;
          blockHmm = contentH;
        }

        if(cursorY + blockHmm > (pageH - margin)){
          pdf.addPage();
          cursorY = margin;
        }

        const x = margin + (contentW - blockWmm) / 2;
        pdf.addImage(imgData, 'JPEG', x, cursorY, blockWmm, blockHmm);
        cursorY += blockHmm + 2;
      }

      const pdfBlob = pdf.output('blob');
      downloadBlob(pdfBlob, pdfName);

    }finally{
      document.body.classList.remove('exporting');
    }
  }

  /* =========================
     IMPORT JSON(s)
  ========================= */
  function importJsonFiles(){
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.multiple = true;

    inp.onchange = async ()=>{
      const files = [...(inp.files || [])];
      if(files.length === 0) return;

      const items = [];

      for(const file of files){
        const text = await file.text();
        const parsed = safeJSONParse(text);

        if(!parsed || typeof parsed !== 'object'){
          alert(`JSON inválido: ${file.name}`);
          continue;
        }

        if(isBackup(parsed)){
          // backup de esta misma página
          for(const rawItem of (parsed.items || [])){
            if(rawItem && rawItem.dataSnapshot){
              // re-normaliza por seguridad (theme/logo/meta)
              const norm = normalizeInspection(rawItem.dataSnapshot, rawItem.sourceFileName || file.name);
              if(norm){
                // conserva id si venía en backup
                norm.id = String(rawItem.id || norm.id);
                norm.inspectionId = String(rawItem.inspectionId || norm.inspectionId);
                norm.importedAtISO = rawItem.importedAtISO || norm.importedAtISO;
                items.push(norm);
              }
            }
          }
          continue;
        }

        const norm = normalizeInspection(parsed, file.name);
        if(!norm){
          alert(`No se pudo importar: ${file.name} (estructura no válida).`);
          continue;
        }

        // Si falta categoría/formulario, lo intentamos inferir del nombre
        if(!norm.category || !norm.form){
          const base = String(file.name || '').replace(/\.json$/i,'');
          // HIST_Cat__Form__STAMP o BBDDINS_Cat__Form__STAMP
          const parts = base.split('__');
          if(parts.length >= 3){
            const maybeCat = parts[0].replace(/^HIST_/, '').replace(/^BBDDINS_/, '').replace(/^informe_/, '');
            const maybeForm = parts[1];
            norm.category = norm.category || normalize(maybeCat.replace(/_/g,' '));
            norm.form = norm.form || normalize(maybeForm.replace(/_/g,' '));
            norm.dataSnapshot.meta = norm.dataSnapshot.meta || {};
            norm.dataSnapshot.meta.category = norm.category;
            norm.dataSnapshot.meta.name = norm.form;
          }
        }

        items.push(norm);
      }

      if(items.length){
        const {added, updated} = upsertMany(items);
        alert(`Importación completada: +${added} nuevo(s), ${updated} actualizado(s).`);
      }else{
        alert('No se importó nada.');
      }
    };

    inp.click();
  }

  /* =========================
     DRAG & DROP
  ========================= */
  function setupDrop(){
    const dz = document.getElementById('dropZone');
    const over = (ev) => { ev.preventDefault(); dz.classList.add('drag'); };
    const leave = (ev) => { ev.preventDefault(); dz.classList.remove('drag'); };
    dz.addEventListener('dragover', over);
    dz.addEventListener('dragenter', over);
    dz.addEventListener('dragleave', leave);
    dz.addEventListener('drop', async (ev) => {
      ev.preventDefault();
      dz.classList.remove('drag');

      const files = [...(ev.dataTransfer && ev.dataTransfer.files ? ev.dataTransfer.files : [])];
      if(!files.length) return;

      const items = [];
      for(const file of files){
        const text = await file.text();
        const parsed = safeJSONParse(text);
        if(!parsed || typeof parsed !== 'object') continue;

        if(isBackup(parsed)){
          for(const rawItem of (parsed.items || [])){
            if(rawItem && rawItem.dataSnapshot){
              const norm = normalizeInspection(rawItem.dataSnapshot, rawItem.sourceFileName || file.name);
              if(norm){
                norm.id = String(rawItem.id || norm.id);
                norm.inspectionId = String(rawItem.inspectionId || norm.inspectionId);
                norm.importedAtISO = rawItem.importedAtISO || norm.importedAtISO;
                items.push(norm);
              }
            }
          }
          continue;
        }

        const norm = normalizeInspection(parsed, file.name);
        if(norm) items.push(norm);
      }

      if(items.length){
        upsertMany(items);
      }else{
        alert('No se importó nada (JSON inválido o sin estructura compatible).');
      }
    });
  }

  function goHome(){
    window.location.href = "index.html";
  }

  /* =========================
     INIT
  ========================= */
  (function init(){
    // documento vacío
    lastEditedISO = nowISO();
    updateLastEditedUI();
    applyFixedLogo();
    renderEmptyDocument();

    updateDbMeta();
    refreshSelectors(false);
    renderList();
    setupDrop();

    // auto cargar último activo
    const active = getActiveId();
    if(active){
      const db = loadDB();
      const it = db.find(x=>String(x.id)===String(active));
      if(it && it.dataSnapshot){
        loadLayoutFromData(it.dataSnapshot);
      }else{
        setActiveId('');
      }
    }
  })();
</script>
</body>
</html>
